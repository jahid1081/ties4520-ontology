<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TTL Subject Viewer</title>

  <style>
    :root{
      --bg:#0b0f16; --panel:#0f1521; --ink:#e8eefc; --muted:#a8b0c2;
      --accent:#4dd4ff; --line:rgba(255,255,255,.08);
      --ok:#64eeac; --warn:#ffcf66; --bad:#ff6b6b;
      --stripe:rgba(255,255,255,.02);
    }
    html,body{background:var(--bg);color:var(--ink);margin:0;font:15px/1.45 system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1280px;margin:36px auto;padding:0 20px}
    .header{display:flex;align-items:center;justify-content:space-between;gap:16px;margin-bottom:14px}
    .title{display:flex;align-items:center;gap:10px}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 18px var(--accent)}
    h1{margin:0;font-size:22px;letter-spacing:.2px}

    .actions{display:flex;gap:10px;flex-wrap:wrap}
    .btn{appearance:none;border:1px solid var(--line);background:var(--panel);color:var(--ink);
         padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn:hover{border-color:var(--accent)}

    .meta{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0 14px}
    .pill{border:1px solid var(--line);background:var(--panel);padding:6px 10px;border-radius:10px;color:var(--muted)}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}

    .alert{border:1px solid var(--line);border-radius:12px;padding:10px 12px;margin-bottom:14px}
    .alert.ok{background:rgba(100,238,172,.07);border-color:rgba(100,238,172,.35);color:var(--ok)}
    .alert.warn{background:rgba(255,207,102,.07);border-color:rgba(255,207,102,.35);color:var(--warn)}
    .alert.bad{background:rgba(255,107,107,.07);border-color:rgba(255,107,107,.35);color:var(--bad)}

    .panel{background:var(--panel);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .panel-head{padding:10px 14px;border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center}
    .panel-head .label{color:var(--muted)}
    .panel-body{padding:0}

    table{width:100%;border-collapse:collapse}
    thead th{position:sticky;top:0;background:rgba(255,255,255,.03);backdrop-filter:saturate(120%);
             border-bottom:1px solid var(--line);padding:10px 12px;text-align:left}
    tbody td{border-top:1px solid var(--line);padding:10px 12px;vertical-align:top}
    tbody tr:nth-child(odd){background:var(--stripe)}
    .key{color:var(--accent)}
    a{color:var(--accent);text-decoration:none}
    a:hover{text-decoration:underline}
    code{background:rgba(255,255,255,.04);border:1px solid var(--line);padding:.2rem .35rem;border-radius:8px}
    .badge{display:inline-block;padding:.15rem .45rem;border:1px solid var(--line);border-radius:8px;background:rgba(255,255,255,.03);color:var(--muted)}
    details{margin-top:16px}
    summary{cursor:pointer;color:var(--muted)}
  </style>

  <script src="https://unpkg.com/n3@1.17.3/browser/n3.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header class="header">
      <div class="title"><div class="dot"></div><h1>TTL Subject Viewer</h1></div>
      <div class="actions">
        <button id="openRaw" class="btn" type="button">Open raw TTL</button>
        <button id="copyNT" class="btn" type="button">Copy as N-Triples</button>
      </div>
    </header>

    <div class="meta">
      <span id="srcPill" class="pill mono"></span>
      <span id="iriPill" class="pill mono"></span>
    </div>

    <div id="status" class="alert ok" role="status" aria-live="polite">Loading…</div>

    <section class="panel">
      <div class="panel-head">
        <span class="label">Subject:</span>
        <span id="subjectLine" class="mono"></span>
      </div>
      <div class="panel-body">
        <table>
          <thead>
            <tr><th>Predicate</th><th>Object</th></tr>
          </thead>
          <tbody id="rows"></tbody>
        </table>
      </div>
    </section>

    <details id="bnSection" hidden>
      <summary>Blank node details</summary>
      <div id="bnContent" class="mono"></div>
    </details>
  </div>

<script>
(function(){
  const $ = s => document.querySelector(s);

  // ------- Robust query handling -------
  const norm = s => (s||"").replace(/&amp;/gi,"&");
  const params = new URLSearchParams(norm(location.search).replace(/^\?/,''));
  const hash   = new URLSearchParams(norm(location.hash).replace(/^#/,''));

  let iri = params.get("iri") || hash.get("iri");
  let src = params.get("src") || hash.get("src") || "individuals.ttl";
  const id = params.get("id") || hash.get("id");

  const srcURL = new URL(src, location.href).href;
  if (!iri && id) iri = srcURL.replace(/#.*$/,'') + "#" + id;

  $("#srcPill").textContent = "src=" + (new URL(srcURL).pathname.split("/").pop() || srcURL);
  $("#iriPill").textContent = "subject=" + (iri || "(missing)");
  $("#openRaw").onclick = () => window.open(srcURL, "_blank");

  const prefixes = {
    "rdf:":"http://www.w3.org/1999/02/22-rdf-syntax-ns#",
    "rdfs:":"http://www.w3.org/2000/01/rdf-schema#",
    "xsd:":"http://www.w3.org/2001/XMLSchema#",
    // support both bases so QNames look nice regardless of how data was minted
    "ind:":"https://jahid1081.github.io/ties4520-ontology/docs/individuals.ttl#",
    "ind2:":"https://jahid1081.github.io/ties4520-ontology/individuals.ttl#",
    "onto:":"https://jahid1081.github.io/ties4520-ontology/ontology.ttl#"
  };
  const qname = u => {for(const [p,b] of Object.entries(prefixes)){if(u.startsWith(b)) return p+u.slice(b.length);} return "<"+u+">";}
  const lit = o => o.language ? `"${o.value}"@${o.language}`
                : (o.datatype && o.datatype.value && o.datatype.value !== prefixes["xsd:"]+"string")
                  ? `"${o.value}"^^${qname(o.datatype.value)}` : `"${o.value}"`;

  function alert(kind,msg){
    const box = $("#status");
    box.className = "alert " + kind;
    box.textContent = msg;
  }

  async function parseTTL(url){
    const res = await fetch(url, {headers:{"Accept":"text/turtle,text/plain;q=0.9,*/*;q=0.8"}});
    if(!res.ok) throw new Error(res.status+" "+res.statusText);
    const ttl = await res.text();
    return new N3.Parser({baseIRI:url}).parse(ttl);
  }

  function render(quads, subjectIRI){
    $("#subjectLine").textContent = qname(subjectIRI);

    const tbody = $("#rows");
    tbody.innerHTML = "";

    const rows = quads.filter(q => q.subject.termType==="NamedNode" && q.subject.value===subjectIRI);

    if(!rows.length){
      const tr = document.createElement("tr");
      tr.innerHTML = '<td colspan="2" class="small">No triples found for that subject.</td>';
      tbody.appendChild(tr);
      return { rows: [], bns: new Map() };
    }

    // collect only direct bnodes for convenience
    const bnodes = new Map();
    rows.forEach(q => { if(q.object.termType==="BlankNode") bnodes.set("_:"+q.object.value, []); });
    if(bnodes.size){
      quads.forEach(q => {
        if(q.subject.termType==="BlankNode"){
          const k = "_:"+q.subject.value;
          if(bnodes.has(k)) bnodes.get(k).push(q);
        }
      });
    }

    // add a row only for real triples (no blanks)
    rows.forEach(q => {
      const pred = qname(q.predicate.value);
      let obj = "";

      if(q.object.termType==="NamedNode"){
        const target = q.object.value;
        obj = '<a class="mono" href="viewer.html?iri='+encodeURIComponent(target)+'">'+qname(target)+'</a>';
      }else if(q.object.termType==="Literal"){
        obj = lit(q.object);
      }else if(q.object.termType==="BlankNode"){
        obj = '<span class="badge">'+("_:"+q.object.value)+'</span>';
      }

      const tr = document.createElement("tr");
      tr.innerHTML = '<td class="key mono">'+pred+'</td><td>'+obj+'</td>';
      tbody.appendChild(tr);
    });

    // render bnodes section only if present
    const bnSec = $("#bnSection"), bnDiv = $("#bnContent");
    if(bnodes.size){
      bnSec.hidden = false;
      let html = "";
      for(const [id,list] of bnodes){
        html += '<div style="margin-top:8px"><span class="badge">'+id+'</span><table><tbody>';
        list.forEach(q=>{
          const pred = qname(q.predicate.value);
          let obj="";
          if(q.object.termType==="NamedNode") obj = qname(q.object.value);
          else if(q.object.termType==="Literal") obj = lit(q.object);
          else obj = '<span class="badge">'+("_:"+q.object.value)+'</span>';
          html += '<tr><td class="key mono" style="padding:6px 10px">'+pred+'</td><td style="padding:6px 10px">'+obj+'</td></tr>';
        });
        html += '</tbody></table></div>';
      }
      bnDiv.innerHTML = html;
    }else{
      bnSec.hidden = true;
    }

    return { rows, bnodes };
  }

  function candidateIRIs(initial){
    const out = new Set(); if(initial) out.add(initial);
    const frag = (initial && initial.includes("#")) ? initial.split("#").pop() : (id || null);
    if(!frag) return [...out];
    const base = srcURL.replace(/#.*$/,'');
    out.add(base + "#"+frag);
    // with/without /docs/
    out.add(base.replace("/ties4520-ontology/","/ties4520-ontology/docs/") + "#"+frag);
    out.add(base.replace("/ties4520-ontology/docs/","/ties4520-ontology/") + "#"+frag);
    return [...out];
  }

  (async () => {
    try{
      if(!iri && !id){ alert("warn","Missing subject. Provide ?iri=… or ?src=…&id=…"); return; }

      alert("", "Loading…");
      const quads = await parseTTL(srcURL);

      let chosen=null, rows=[], bns=new Map();
      for(const cand of candidateIRIs(iri)){
        ({rows,bns} = render(quads, cand));
        if(rows.length){ chosen=cand; break; }
      }

      if(!chosen){
        const frag = (iri && iri.includes("#")) ? iri.split("#").pop() : (id || null);
        if(frag){
          const hit = quads.find(q => q.subject.termType==="NamedNode" && q.subject.value.endsWith("#"+frag));
          if(hit){
            ({rows,bns} = render(quads, hit.subject.value));
            if(rows.length) chosen = hit.subject.value;
          }
        }
      }

      $("#copyNT").onclick = async () => {
        if(!rows.length){ alert("warn","No triples to copy."); return; }
        const w = new N3.Writer({format:"N-Triples"});
        rows.forEach(q=>w.addQuad(q));
        for(const [,list] of bns) list.forEach(q=>w.addQuad(q));
        w.end(async (err,nt)=>{
          if(err){ alert("bad","Failed to serialise."); return; }
          await navigator.clipboard.writeText(nt);
          alert("ok","Copied "+ nt.split("\n").filter(Boolean).length +" triple(s) to clipboard.");
        });
      };

      alert(chosen ? "ok" : "warn", chosen ? "Done." : "Done. No triples for that IRI in this dataset.");
    }catch(e){
      alert("bad","Failed: "+e.message);
      console.error(e);
    }
  })();
})();
</script>
</body>
</html>
