<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TTL Subject Viewer</title>

  <style>
    :root{
      --bg:#0b0f16; --panel:#0f1521; --ink:#e8eefc; --muted:#a8b0c2;
      --accent:#4dd4ff; --line:rgba(255,255,255,.08); --good:#64eeac; --bad:#ff6b6b;
    }
    html,body{background:var(--bg); color:var(--ink); margin:0; font:15px/1.45 system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1100px; margin:40px auto; padding:0 16px}
    .header{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px}
    .brand{display:flex; align-items:center; gap:10px}
    .dot{width:10px; height:10px; border-radius:50%; background:var(--accent); box-shadow:0 0 18px var(--accent)}
    h1{font-size:20px; margin:0}
    .bar{display:flex; flex-wrap:wrap; gap:10px; align-items:center; color:var(--muted)}
    .pill{border:1px solid var(--line); background:var(--panel); padding:6px 10px; border-radius:10px}
    .btn{appearance:none; border:1px solid var(--line); background:var(--panel); color:var(--ink);
         padding:8px 12px; border-radius:10px; cursor:pointer}
    .btn:hover{border-color:var(--accent)}
    .panel{background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:14px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .table{width:100%; border-collapse:collapse; margin-top:6px}
    .table th,.table td{border-top:1px solid var(--line); padding:10px; vertical-align:top}
    .key{color:var(--accent)}
    .small{color:var(--muted); font-size:13px}
    .badge{display:inline-block; padding:.15rem .45rem; border:1px solid var(--line);
           border-radius:8px; background:rgba(255,255,255,.03); color:var(--muted); margin-left:6px}
    details{margin-top:14px}
    .warn{color:var(--bad)}
    .ok{color:var(--good)}
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    code{background:rgba(255,255,255,.04); border:1px solid var(--line); padding:.2rem .35rem; border-radius:8px}
  </style>

  <script src="https://unpkg.com/n3@1.17.3/browser/n3.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header class="header">
      <div class="brand"><div class="dot"></div><h1>TTL Subject Viewer</h1></div>
      <div class="bar small">
        <span id="srcPill" class="pill mono"></span>
        <span id="iriPill" class="pill mono"></span>
        <button id="openRaw" class="btn" type="button">Open raw TTL</button>
        <button id="copyNT" class="btn" type="button">Copy as N-Triples</button>
      </div>
    </header>

    <div id="status" class="small"></div>

    <section class="panel">
      <div id="titleLine" class="small"></div>
      <table class="table mono" id="triplesTable">
        <thead><tr><th>Predicate</th><th>Object</th></tr></thead>
        <tbody id="rows"></tbody>
      </table>

      <details id="bnSection" hidden>
        <summary class="small">Blank node details</summary>
        <div id="bnContent" class="mono"></div>
      </details>
    </section>

    <p class="small" style="margin-top:12px">
      Tip: link like <code>viewer.html?iri=https://…/docs/individuals.ttl#Series_Poker_Face_S01_E01</code>
      or <code>viewer.html?src=individuals.ttl&amp;id=Series_The_Boys_S01_E01</code>.
    </p>
  </div>

<script>
(function () {
  const $ = (s) => document.querySelector(s);

  // -------- Robust query parsing (fix accidental &amp;) --------
  const normalizeAmp = (s) => (s || "").replace(/&amp;/gi, "&");
  const search = normalizeAmp(location.search).replace(/^\?/, "");
  const hash   = normalizeAmp(location.hash).replace(/^#/, "");
  const params = new URLSearchParams(search);
  const hq     = new URLSearchParams(hash);

  let iri = params.get("iri") || hq.get("iri");
  let src = params.get("src") || hq.get("src") || "individuals.ttl";
  const id = params.get("id") || hq.get("id");

  // Resolve src to an absolute URL relative to this page (so fetch works)
  const srcURL = new URL(src, location.href).href;

  // If iri missing but id provided, build iri from src base + fragment
  if (!iri && id) iri = srcURL.replace(/#.*$/, "") + "#" + id;

  $("#srcPill").textContent = "src=" + (new URL(srcURL).pathname.split("/").slice(-1)[0] || srcURL);
  $("#iriPill").textContent = "subject=" + (iri || "(missing)");
  $("#openRaw").onclick = () => window.open(srcURL, "_blank");

  const prefixes = {
    "rdf:":  "http://www.w3.org/1999/02/22-rdf-syntax-ns#",
    "rdfs:": "http://www.w3.org/2000/01/rdf-schema#",
    "xsd:":  "http://www.w3.org/2001/XMLSchema#",
    // Both bases so QNames look nice whether /docs/ is present or not:
    "onto:": "https://jahid1081.github.io/ties4520-ontology/ontology.ttl#",
    "ind:":  "https://jahid1081.github.io/ties4520-ontology/docs/individuals.ttl#",
    "ind2:": "https://jahid1081.github.io/ties4520-ontology/individuals.ttl#"
  };

  const qname = (u) => {
    for (const [pfx, base] of Object.entries(prefixes)) {
      if (u.startsWith(base)) return pfx + u.slice(base.length);
    }
    return "<" + u + ">";
  };

  const lit2txt = (obj) => {
    if (obj.language) return `"${obj.value}"@${obj.language}`;
    if (obj.datatype && obj.datatype.value && obj.datatype.value !== prefixes["xsd:"] + "string")
      return `"${obj.value}"^^${qname(obj.datatype.value)}`;
    return `"${obj.value}"`;
  };

  async function parseTTL(url) {
    const res = await fetch(url, { headers: { Accept: "text/turtle,text/plain;q=0.9,*/*;q=0.8" } });
    if (!res.ok) throw new Error(res.status + " " + res.statusText);
    const ttl = await res.text();
    const parser = new N3.Parser({ baseIRI: url });
    return parser.parse(ttl);
  }

  function renderRows(quads, subjectIRI) {
    const labelQuad = quads.find(
      (q) =>
        q.subject.termType === "NamedNode" &&
        q.subject.value === subjectIRI &&
        q.predicate.termType === "NamedNode" &&
        q.predicate.value === prefixes["rdfs:"] + "label"
    );

    $("#titleLine").innerHTML =
      "Subject: <span class=\"mono\">" + qname(subjectIRI) + "</span>" +
      (labelQuad ? " · Label: <strong>" + labelQuad.object.value + "</strong>" : "");

    const tbody = $("#rows");
    tbody.innerHTML = "";

    const rows = quads.filter(
      (q) => q.subject.termType === "NamedNode" && q.subject.value === subjectIRI
    );

    if (!rows.length) {
      tbody.innerHTML =
        '<tr><td colspan="2" class="small">No triples found for that subject.</td></tr>';
      return { rows, bnodes: new Map() };
    }

    // collect bnode trees rooted from these rows
    const bnodes = new Map();
    rows.forEach((q) => {
      if (q.object.termType === "BlankNode") {
        const k = "_:" + q.object.value;
        bnodes.set(k, []);
      }
    });
    if (bnodes.size) {
      quads.forEach((q) => {
        if (q.subject.termType === "BlankNode") {
          const k = "_:" + q.subject.value;
          if (bnodes.has(k)) bnodes.get(k).push(q);
        }
      });
    }

    rows.forEach((q) => {
      const pred = qname(q.predicate.value);
      let obj = "";
      if (q.object.termType === "NamedNode") obj = qname(q.object.value);
      else if (q.object.termType === "Literal") obj = lit2txt(q.object);
      else if (q.object.termType === "BlankNode") obj = '<span class="badge">' + ("_:" + q.object.value) + "</span>";
      const tr = document.createElement("tr");
      tr.innerHTML = "<td class=\"key\">" + pred + "</td><td>" + obj + "</td>";
      tbody.appendChild(tr);
    });

    // render any collected blank nodes
    const bnSec = $("#bnSection");
    const bnDiv = $("#bnContent");
    if (bnodes.size) {
      bnSec.hidden = false;
      let html = "";
      for (const [id, list] of bnodes) {
        html += '<div style="margin-top:8px"><span class="badge">' + id + "</span><table class=\"table\"><tbody>";
        list.forEach((q) => {
          const pred = qname(q.predicate.value);
          let obj = "";
          if (q.object.termType === "NamedNode") obj = qname(q.object.value);
          else if (q.object.termType === "Literal") obj = lit2txt(q.object);
          else if (q.object.termType === "BlankNode") obj = '<span class="badge">' + ("_:" + q.object.value) + "</span>";
          html += "<tr><td class=\"key\">" + pred + "</td><td>" + obj + "</td></tr>";
        });
        html += "</tbody></table></div>";
      }
      bnDiv.innerHTML = html;
    } else {
      bnSec.hidden = true;
    }

    return { rows, bnodes };
  }

  (async () => {
    try {
      if (!iri) {
        $("#status").innerHTML =
          '<span class="warn">Missing subject. Provide <code>?iri=…</code> or <code>?src=…&amp;id=…</code>.</span>';
        return;
      }

      $("#status").textContent = "Loading " + srcURL + " …";
      const quads = await parseTTL(srcURL);

      // 1) Try the IRI as provided
      let { rows, bnodes } = renderRows(quads, iri);

      // 2) If not found and the IRI has a fragment, retry with dataset base + same fragment
      if (!rows.length && iri.includes("#")) {
        const frag = iri.split("#").pop();
        const alt = srcURL.replace(/#.*$/, "") + "#" + frag;
        if (alt !== iri) {
          ({ rows, bnodes } = renderRows(quads, alt));
          if (rows.length) {
            iri = alt;
            $("#iriPill").textContent = "subject=" + iri;
          }
        }
      }

      // Copy N-Triples for displayed subject (+ any direct bnodes)
      $("#copyNT").onclick = async () => {
        if (!rows.length) { $("#status").textContent = "No triples to copy."; return; }
        const w = new N3.Writer({ format: "N-Triples" });
        rows.forEach((q) => w.addQuad(q));
        for (const [, list] of (bnodes || new Map())) list.forEach((q) => w.addQuad(q));
        w.end(async (err, nt) => {
          if (err) { $("#status").innerHTML = '<span class="warn">Failed to serialise.</span>'; return; }
          await navigator.clipboard.writeText(nt);
          $("#status").innerHTML =
            '<span class="ok">Copied ' + nt.split("\n").filter(Boolean).length + " triple(s) to clipboard.</span>";
        });
      };

      if (!rows.length) {
        $("#status").innerHTML =
          '<span class="warn">Done. No triples for that IRI in this dataset.</span>';
      } else {
        $("#status").textContent = "Done.";
      }
    } catch (e) {
      $("#status").innerHTML = '<span class="warn">Failed: ' + e.message + "</span>";
      console.error(e);
    }
  })();
})();
</script>
</body>
</html>
