<!doctype html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
  <meta http-equiv="Content-Type" content="application/xhtml+xml; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>TTL Subject Viewer</title>
  <style type="text/css">
    :root{
      --bg:#0b0f16; --panel:#0f1521; --ink:#e8eefc; --muted:#a8b0c2;
      --accent:#4dd4ff; --line:rgba(255,255,255,.08); --good:#64eeac; --bad:#ff6b6b;
    }
    html,body{background:var(--bg); color:var(--ink); margin:0; font:15px/1.45 system-ui,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:1100px; margin:40px auto; padding:0 16px}
    .header{display:flex; align-items:center; justify-content:space-between; gap:16px; margin-bottom:16px}
    .brand{display:flex; align-items:center; gap:10px}
    .dot{width:10px;height:10px;border-radius:50%;background:var(--accent);box-shadow:0 0 18px var(--accent)}
    h1{font-size:20px; margin:0}
    .bar{display:flex; flex-wrap:wrap; gap:10px; align-items:center; color:var(--muted)}
    .pill{border:1px solid var(--line); background:var(--panel); padding:6px 10px; border-radius:10px}
    .btn{appearance:none; border:1px solid var(--line); background:var(--panel); color:var(--ink);
         padding:8px 12px; border-radius:10px; cursor:pointer}
    .btn:hover{border-color:var(--accent)}
    .panel{background:var(--panel); border:1px solid var(--line); border-radius:14px; padding:14px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .table{width:100%; border-collapse:collapse; margin-top:6px}
    .table th,.table td{border-top:1px solid var(--line); padding:10px; vertical-align:top}
    .key{color:var(--accent)}
    .small{color:var(--muted); font-size:13px}
    .badge{display:inline-block; padding:.15rem .45rem; border:1px solid var(--line);
           border-radius:8px; background:rgba(255,255,255,.03); color:var(--muted); margin-left:6px}
    details{margin-top:14px}
    .warn{color:var(--bad)}
    .ok{color:var(--good)}
    .footer{margin-top:24px; color:var(--muted)}
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    code{background:rgba(255,255,255,.04); border:1px solid var(--line); padding:.2rem .35rem; border-radius:8px}
  </style>
  <script type="text/javascript" src="https://unpkg.com/n3@1.17.3/browser/n3.min.js"></script>
</head>
<body>
  <div class="wrap">
    <header class="header">
      <div class="brand"><div class="dot"></div><h1>TTL Subject Viewer</h1></div>
      <div class="bar small">
        <span id="srcPill" class="pill mono"></span>
        <span id="iriPill" class="pill mono"></span>
        <button id="openRaw" class="btn" type="button">Open raw TTL</button>
        <button id="copyNT" class="btn" type="button">Copy as N-Triples</button>
      </div>
    </header>

    <div id="status" class="small"></div>

    <section class="panel">
      <div id="titleLine" class="small"></div>
      <table class="table mono" id="triplesTable">
        <thead><tr><th>Predicate</th><th>Object</th></tr></thead>
        <tbody id="rows"></tbody>
      </table>

      <details id="bnSection" hidden="hidden">
        <summary class="small">Blank node details</summary>
        <div id="bnContent" class="mono"></div>
      </details>
    </section>

    <div class="footer small">Tip: link like
      <code>viewer.html?src=individuals.ttl&amp;id=Series_Poker_Face_S01_E01</code>
      or
      <code>viewer.html?iri=https://…/individuals.ttl#Series_The_Boys_S01_E01</code>.
    </div>
  </div>

<script type="text/javascript">
(function(){
  const $ = function(s){ return document.querySelector(s); };

  // Normalize any accidental &amp; to & before parsing params
  function normalizeAmp(s){ return (s || "").replace(/&amp;/gi, "&"); }

  const rawSearch = normalizeAmp(window.location.search);
  const params = new URLSearchParams(rawSearch.startsWith("?") ? rawSearch.slice(1) : rawSearch);

  const rawHash = normalizeAmp(window.location.hash);
  const hashParams = new URLSearchParams(rawHash.startsWith("#") ? rawHash.slice(1) : rawHash);

  var iri = params.get("iri") || hashParams.get("iri");
  var src = params.get("src") || hashParams.get("src") || "individuals.ttl";
  var id  = params.get("id")  || hashParams.get("id");

  if (!iri && id) iri = src.replace(/#.*$/, "") + "#" + id;

  $("#srcPill").textContent = "src=" + src;
  $("#iriPill").textContent = "subject=" + (iri || "(missing)");
  $("#openRaw").onclick = function(){ window.open(src, "_blank"); };

  if (!iri) {
    $("#status").innerHTML = '<span class="warn">Missing subject. Provide <code>?iri=…</code> or <code>?src=…&amp;id=…</code>.</span>';
    return;
  }

  var prefixes = {
    "rdf:":"http://www.w3.org/1999/02/22-rdf-syntax-ns#",
    "rdfs:":"http://www.w3.org/2000/01/rdf-schema#",
    "xsd:":"http://www.w3.org/2001/XMLSchema#",
    "onto:":"https://jahid1081.github.io/ties4520-ontology/ontology.ttl#",
    "ind:":"https://jahid1081.github.io/ties4520-ontology/individuals.ttl#"
  };

  function qname(iriVal){
    for (var pfx in prefixes){
      var base = prefixes[pfx];
      if (iriVal.indexOf(base) === 0) return pfx + iriVal.slice(base.length);
    }
    return "<" + iriVal + ">";
  }

  function literalToText(obj){
    if (obj.language) return '"' + obj.value + '"@' + obj.language;
    if (obj.datatype && obj.datatype.value && obj.datatype.value !== prefixes["xsd:"] + "string")
      return '"' + obj.value + '"^^' + qname(obj.datatype.value);
    return '"' + obj.value + '"';
  }

  async function load() {
    $("#status").textContent = "Loading " + src + " …";
    try {
      var res = await fetch(src, { headers: { "Accept":"text/turtle,text/plain;q=0.9,*/*;q=0.8" }});
      if (!res.ok) throw new Error(res.status + " " + res.statusText);
      var ttl = await res.text();

      $("#status").textContent = "Parsing …";
      var parser = new N3.Parser({ baseIRI: src });
      var quads = parser.parse(ttl);

      var rows = [];
      var bnodes = {};
      quads.forEach(function(q){
        var subj = (q.subject.termType === "NamedNode") ? q.subject.value :
                   (q.subject.termType === "BlankNode" ? "_:" + q.subject.value : "");
        if (subj === iri) {
          rows.push(q);
          if (q.object.termType === "BlankNode") {
            var key = "_:" + q.object.value;
            bnodes[key] = bnodes[key] || [];
          }
        }
      });

      if (Object.keys(bnodes).length) {
        quads.forEach(function(q){
          if (q.subject.termType === "BlankNode"){
            var key = "_:" + q.subject.value;
            if (bnodes[key]) bnodes[key].push(q);
          }
        });
      }

      var labelQuad = quads.find(function(q){
        return q.subject.termType === "NamedNode" &&
               q.subject.value === iri &&
               q.predicate.termType === "NamedNode" &&
               q.predicate.value === prefixes["rdfs:"] + "label";
      });

      $("#titleLine").innerHTML =
        "Subject: <span class=\"mono\">" + qname(iri) + "</span>" +
        (labelQuad ? " · Label: <strong>" + labelQuad.object.value + "</strong>" : "");

      var tbody = $("#rows");
      tbody.innerHTML = "";
      if (!rows.length) {
        tbody.innerHTML = "<tr><td colspan=\"2\" class=\"small\">No triples found for that subject.</td></tr>";
      } else {
        rows.forEach(function(q){
          var pred = qname(q.predicate.value);
          var objTxt = "";
          if (q.object.termType === "NamedNode") objTxt = qname(q.object.value);
          else if (q.object.termType === "Literal") objTxt = literalToText(q.object);
          else if (q.object.termType === "BlankNode") objTxt = "<span class=\"badge\">" + ("_:" + q.object.value) + "</span>";
          var tr = document.createElement("tr");
          tr.innerHTML = "<td class=\"key\">" + pred + "</td><td>" + objTxt + "</td>";
          tbody.appendChild(tr);
        });
      }

      var bnSec = $("#bnSection");
      var bnDiv = $("#bnContent");
      if (Object.keys(bnodes).length) {
        bnSec.hidden = false;
        var html = "";
        Object.keys(bnodes).forEach(function(id){
          html += "<div style=\"margin-top:8px\"><span class=\"badge\">" + id + "</span><table class=\"table\"><tbody>";
          bnodes[id].forEach(function(q){
            var pred = qname(q.predicate.value);
            var obj = "";
            if (q.object.termType === "NamedNode") obj = qname(q.object.value);
            else if (q.object.termType === "Literal") obj = literalToText(q.object);
            else if (q.object.termType === "BlankNode") obj = "<span class=\"badge\">" + ("_:" + q.object.value) + "</span>";
            html += "<tr><td class=\"key\">" + pred + "</td><td>" + obj + "</td></tr>";
          });
          html += "</tbody></table></div>";
        });
        bnDiv.innerHTML = html;
      } else {
        bnSec.hidden = true;
      }

      $("#copyNT").onclick = async function(){
        var writer = new N3.Writer({ format: "N-Triples" });
        rows.forEach(function(q){ writer.addQuad(q); });
        Object.keys(bnodes).forEach(function(id){
          bnodes[id].forEach(function(q){ writer.addQuad(q); });
        });
        writer.end(async function(err, ntriples){
          if (err) { alert("Failed to serialise"); return; }
          await navigator.clipboard.writeText(ntriples);
          $("#status").innerHTML = "<span class=\"ok\">Copied " + ntriples.split("\n").filter(Boolean).length + " triple(s) to clipboard.</span>";
        });
      };

      $("#status").textContent = "Done.";
    } catch (err) {
      $("#status").innerHTML = "<span class=\"warn\">Failed: " + err.message + "</span>";
      console.error(err);
    }
  }

  load();
})();
</script>
</body>
</html>
